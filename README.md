# rotatefiles

é«˜æ€§èƒ½ã€ç”Ÿäº§çº§æ—¥å¿—è½®è½¬ç»„ä»¶

rotatefiles æ˜¯ä¸€ä¸ªä¸ºç”Ÿäº§ç¯å¢ƒè®¾è®¡çš„æ—¥å¿—å†™å…¥ä¸è½®æ¢ç»„ä»¶ï¼Œæ”¯æŒï¼š

* åŸºäºæ—¶é—´å‘¨æœŸè‡ªåŠ¨åˆ‡æ¢æ—¥å¿—æ–‡ä»¶
* æ”¯æŒè½¯é“¾æŒ‡å‘æœ€æ–°æ—¥å¿—æ–‡ä»¶
* æ”¯æŒå¼‚æ­¥å†™å…¥ï¼Œé™ä½ç£ç›˜ IO ä¸å†™é”å†²çª
* æ”¯æŒè‡ªåŠ¨æ¸…ç†å†å²æ—¥å¿—æ–‡ä»¶
* æ”¯æŒ Flush å‘¨æœŸæ§åˆ¶
* æ”¯æŒåŒæ­¥å…³é—­ä¸ä¼˜é›…é€€å‡º
* æ”¯æŒè‡ªå®šä¹‰ Writer åŒ…è£…ï¼ˆå¦‚ç¼“å†²å†™ã€åŠ å¯†å†™å…¥ç­‰ï¼‰
* æ”¯æŒå¤–éƒ¨åŠ¨æ€é…ç½®æ–‡ä»¶åç”Ÿæˆ

è¯¥ç»„ä»¶å¯åµŒå…¥ä»»æ„æ—¥å¿—ç³»ç»Ÿï¼Œå°¤å…¶é€‚ç”¨äºï¼š

* Web æœåŠ¡å¤§é‡é«˜é¢‘æ—¥å¿—å†™å…¥
* AI åœ¨çº¿æ¨ç†ç³»ç»Ÿæ—¥å¿—è½ç›˜
* æ”¯æŒæ—¥å¿—æŒ‰åˆ†é’Ÿ/å°æ—¶/å¤©åˆ‡åˆ†
* å¤§è§„æ¨¡è¾¹ç¼˜è®¡ç®—è®¾å¤‡æœ¬åœ°æ—¥å¿—

---

---

## âœ¨ ç‰¹æ€§æ¦‚è§ˆ

| èƒ½åŠ›               | è¯´æ˜            |
| ---------------- | ------------- |
| å¼‚æ­¥å†™å…¥ AsyncWriter | é™ä½å†™å…¥ç³»ç»Ÿå¼€é”€      |
| å‘¨æœŸ rotation      | è‡ªåŠ¨åˆ‡æ¢æ–‡ä»¶        |
| è½¯é“¾ç®¡ç†             | å§‹ç»ˆæŒ‡å‘æœ€æ–°æ–‡ä»¶      |
| è‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶          | æ”¯æŒ MaxFileNum |
| å¯æ’æ‹”ç”Ÿæˆå™¨           | å®šä¹‰æ–‡ä»¶åé€»è¾‘       |
| å¯æ’æ‹” Writer       | è‡ªå®šä¹‰ç¼“å­˜æ¨¡å‹       |
| å¯è§‚æµ‹æ€§             | æ”¯æŒçŠ¶æ€è¯»å–        |

---

---

## ğŸ”§ ä¸»è¦ç»„ä»¶è¯´æ˜

### â‘  `RotateGenerator`

è´Ÿè´£å‘¨æœŸæ€§äº§ç”Ÿæ—¥å¿—ç›®æ ‡ä¿¡æ¯ï¼š

```go
type RotateGenerator interface {
    Start(ctx context.Context) error
	Generate() RotateInfo
	Stop(context.Context) error
}
```

å•æ¬¡ç”Ÿæˆç»“æ„ï¼š

```go
type RotateInfo struct {
	Symlink  string // è½¯é“¾ï¼Œå¦‚ ./app.log
	Filename string // åŸå§‹æ—¥å¿—ï¼Œå¦‚ ./app.log
	FilePath string // å®é™…è¾“å‡ºæ–‡ä»¶ï¼Œå¦‚ ./app.log.202501021030
}
```

å…¸å‹åº”ç”¨é€»è¾‘ï¼š

* æ¯å°æ—¶ç”Ÿæˆä¸€ä¸ªæ–°æ–‡ä»¶å
* æ¯å¤©ç”Ÿæˆä¸€ä¸ªæ–°æ–‡ä»¶å
* æ‰‹åŠ¨è¿œç«¯é…ç½®åŠ¨æ€æ¨é€æ–°è·¯å¾„

---

### â‘¡ `PeriodicGenerator[T]`

ç”¨äºå®šæ—¶åˆ·æ–° RotateInfo

ç‰¹æ€§ï¼š

- âœ” å¼ºä¸€è‡´å‘¨æœŸä¿è¯
- âœ” æ”¯æŒå¤–éƒ¨ context ä¸­æ–­
- âœ” æ”¯æŒ retry
- âœ” æ”¯æŒé”™è¯¯å›è°ƒ

ç¤ºä¾‹ï¼š

```go
gen := NewPeriodicGeneratorFunc(
	func(ctx context.Context) (RotateInfo, error) {
		file := fmt.Sprintf("app.log.%s", time.Now().Format("200601021504"))
		return RotateInfo{Symlink: "app.log", FilePath: file}, nil
	},
	time.Minute,
)
```

---

### â‘¢ `rotateFile`

æ ¸å¿ƒ Writer å®ç°ï¼š

* Write æ—¶å†™å…¥å¼‚æ­¥ writer
* è½®æ¢é˜¶æ®µè‡ªåŠ¨åˆ‡æ¢/å…³é—­/å›æ”¶æ—§ Writer
* flush å®šæ—¶æ‰§è¡Œ
* Close æ”¯æŒå¯ç­‰å¾…å¼é€€å‡º

---

---

## ğŸ§± æ¶æ„æµç¨‹å›¾

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ RotateGenerator  â”‚
                â”‚ ç”Ÿæˆ FilePath    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚å‘¨æœŸè§¦å‘
                        â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ PeriodicGenerator[RotateInfo] â”‚
         â”‚ ç¼“å­˜æœ€æ–° FilePath              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚æ¯æ¬¡ flush æ—¶æ£€æŸ¥
                 â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ rotateFile   â”‚
           â”‚ æ–‡ä»¶åˆ‡æ¢åˆ¤æ–­   â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚åˆ›å»ºæ–°æ–‡ä»¶ + symlink
                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ AsyncWriterï¼ˆåŒ…è£…ï¼‰    â”‚
          â”‚ç¼“å†² / å¼‚æ­¥è½ç›˜ / ä¼˜åŒ–IO â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨ç¤ºä¾‹

```go
opt := &RotateOption{
	RotateGenerator: NewRotateGenerator(
		func(ctx context.Context) (RotateInfo, error) {
			t := time.Now().Format("200601021504")
			return RotateInfo{
				Symlink:  "app.log",
				Filename: "app.log",
				FilePath: "app.log." + t,
			}, nil
		},
		time.Minute,
	),
	MaxFileNum: 7,

	NewWriter: func(ctx context.Context, w io.Writer) (AsyncWriter, error) {
		return NewAsyncBufferedWriter(w), nil
	},
	FlushDuration: time.Second,
}
opt.RotateGenerator.Start(context.TODO())

w, err := NewRotateFile(opt)
if err != nil {
	panic(err)
}

defer w.Close()

for i := 0; i < 10000; i++ {
	_, _ = w.Write([]byte("hello rotate\n"))
}
```

---

---

## ğŸ”„ è‡ªåŠ¨åˆ‡æ¢æ–‡ä»¶æ—¶è¡Œä¸º

åœ¨æ–°å‘¨æœŸè§¦å‘ rotate æ—¶ï¼š

1. Flush å½“å‰ç¼“å†²æ•°æ®
2. Close å½“å‰æ–‡ä»¶å¥æŸ„
3. åˆ›å»ºæ–°æ–‡ä»¶
4. é‡æ–° NewWriter
5. æ›´æ–°è½¯é“¾
6. æ¸…ç†å†å²æ–‡ä»¶

è¿™ä¸€è¿‡ç¨‹å¯¹è°ƒç”¨è€…é€æ˜ã€‚

---

---

## ğŸ§  å¼‚æ­¥å†™å…¥æœºåˆ¶è¯´æ˜

å…¸å‹ AsyncWriter èƒ½å®ç°ï¼š

* Buffered Write
* èšåˆå†™-AIO
* è‡ªé€‚åº”å†™æ¨é€
* å…¨é“¾è·¯ flush å¯æ§

è½ç›˜è§¦å‘æ–¹å¼ï¼š

* é˜Ÿåˆ—ç©º â†’ è‡ªåŠ¨ flush
* flush ticker â†’ å¼ºåˆ¶ flush
* close æ—¶ â†’ ä¼˜é›… flush

æ— æ•°æ®ä¸¢å¤±é£é™©ã€‚

---

---

## ğŸ§¹ æ–‡ä»¶æ¸…ç†ç­–ç•¥è¯´æ˜

æŒ‡å®šï¼š

```go
MaxFileNum = 7
```

ç³»ç»Ÿä¼šï¼š

* æ”¶é›†æ‰€æœ‰ `{Filename}.*` çœŸå®æ–‡ä»¶
* æ’é™¤è½¯é“¾
* æŒ‰ä¿®æ”¹æ—¶é—´æ’åº
* è¶…å‡ºæ•°é‡éƒ¨åˆ†åˆ é™¤

ä¸ä¼šè¯¯åˆ è½¯é“¾æ–‡ä»¶ä¸ä¼šè¯¯åˆ éæ—¥å¿—æ–‡ä»¶

---

---

## ğŸ§¯ é”™è¯¯å¤„ç†æœºåˆ¶

é‡åˆ°é”™è¯¯ï¼š

* æ–°æ–‡ä»¶æ‰“å¼€å¤±è´¥ â†’ ç»§ç»­å†™æ—§æ–‡ä»¶
* symlink åˆ›å»ºå¤±è´¥ â†’ æ—¥å¿—ä»å¯å†™
* flush å¤±è´¥ â†’ ä¸å½±å“åç»­å†™å…¥
* generator å‡ºé”™ â†’ ä½¿ç”¨ä¸Šä¸€æ¬¡å¯ç”¨å€¼

ä¿è¯æ—¥å¿—ä¸ä¸¢å¤±

---

---

## ğŸ§² çº¿ç¨‹å®‰å…¨ä¿è¯

* Write ä¼šæŒæœ‰é”å†™å…¥
* Flushã€Rotate æœŸé—´ä¸ä¼šå¹¶å‘å†™
* Latest Rotation æ•°æ®å®‰å…¨è¯»å–

æ³¨ï¼šé”ç²’åº¦ä¸º Writer åˆ‡æ¢çº§åˆ«ï¼Œååæ€§èƒ½ä¾èµ– AsyncWriter æ€§èƒ½ã€‚

---

---

## ğŸ§  æœ€ä½³å®è·µå»ºè®®

| å»ºè®®                    | åŸå›            |
| --------------------- | ------------ |
| FlushDuration â‰¤ 300ms | ç£ç›˜å†™å…¥å»¶è¿Ÿå¯æ§     |
| ä½¿ç”¨ SSD æˆ– NVMe         | æ›´ç¨³å®šçš„å†™å»¶æ—¶      |
| ä½¿ç”¨è½¯é“¾è¿½è¸ªæ—¥å¿—æ–‡ä»¶            | è¿ç»´å‹å¥½         |
| MaxFileNum æ§åˆ¶ 5~15    | ç©ºé—´ç¨³å®š         |
| åˆ‡åˆ†å‘¨æœŸé¿å…å°äº 30s          | é¢‘ç¹ Close æ€§èƒ½å·® |

---

---

## ğŸ”Œ æ‰©å±•æ–¹æ¡ˆ

è¯¥ç»„ä»¶å…è®¸æ‰©å±•ï¼š

### ğŸ“Œ è‡ªå®šä¹‰åˆ‡å‰²ç­–ç•¥

```go
æ¯å°æ—¶åˆ‡å‰²
æ¯å¤© 00:00 åˆ‡å‰²
æŒ‰æ–‡ä»¶å¤§å°åˆ‡å‰²
æ‰‹åŠ¨è§¦å‘åˆ‡å‰²
æŒ‰è¿œç«¯é€šçŸ¥åˆ‡å‰²
```

### ğŸ“Œ è‡ªå®šä¹‰ Writer

ä¾‹å¦‚ï¼š

```go
func NewWriter(ctx context.Context, w io.Writer) (AsyncWriter, error) {
	return logCompressionWriter(w), nil
}
```

å¯ä»¥ï¼š

* gzip å‹ç¼©å†™å…¥
* æŒ‰è¡Œæ‰¹é‡å†™å…¥
* metrics åŒ…è£…

---

# License

MIT
